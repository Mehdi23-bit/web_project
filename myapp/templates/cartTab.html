<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% load static %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
    <title>Cart</title>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% include "header.html" %}
    
    <main>
        <section class="parallax-section" id="section2" style="background-image: url('{% static 'img/pexels37.jpg' %}');">
            <div class="overlay">
                <h1>My Cart</h1>
            </div>
        </section>

        <div class="cta-banner">
            <p>Review your selected items before proceeding to checkout. Adjust quantities or remove items as needed.</p>
        </div>

        <div class="cart-content">
            <!-- Product Listing on the Left -->
            <div class="cart-items">
                {% if cart.get_prod.items %}
                {% for key, item in cart.get_prod.items.items %}
                <div class="cart-item" data-product-id="{{ item.id }}">
                    <div class="product-image">
                        <img src="{{ item.img }}" alt="Product Image">
                    </div>
                    <div class="product-details">
                        <h2>{{ item.name }}</h2>
                        <p>Color: OLIVE/MULTI</p>
                        <p>Size: S</p>
                        <p>In Stock</p>
                    </div>
                    <div class="product-pricing">
                        <div class="price-label">
                            <span>Each:</span>
                            <span class="each-price">{{ item.price }}</span>
                        </div>
                        <div class="quantity">
                            <label for="quantity">Qty:</label>
                            <select id="quantity" name="quantity" class="quantity_class" data-product-id="{{ item.id }}">
                                {% for i in "x"|rjust:"10" %}
                                <option value="{{ forloop.counter }}" {% if item.qte == forloop.counter %}selected{% endif %}>
                                    {{ forloop.counter }}
                                </option>
                            {% endfor %}
                                
                                 </select>
                        </div>
                        <div class="total-price">
                            <span class="span">${{ item.pro_total }}</span>
                        </div>
                    </div>
                    <div class="actions">
                        <a href="#">Edit</a> |
                        <a href="#" class="remove-item">Remove</a> |
                        <a href="#">Move to Wishlist</a> |
                        <a href="#">Save for Later</a>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        
            <!-- Checkout Section on the Right -->
            
             
            

            <div class="cart-checkout">
                <div class="order-summary">
                    <p class="total-price">Total: ${{cart.get_prod.total}}</p>
                    <p class="discount">Discount: - ${{ cart.get_prod.discount }}</p>
                    <p class="final-total"><strong> Estimated Total: ${{ cart.get_prod.final_total }}</strong></p>
                </div>
                <button class="checkout-btn"><a href="{% url 'myapp:shipping_info' %}">Checkout</a></button>
            </div>

            </div>
        </div>
        
<script>

    // Listen for changes on any select element with class 'quantity-input'
    // Assuming you add a data-product-id attribute to your select

        // Prepare the data to be sent
        

        // Send the AJAX request
        $('.quantity_class').on('change', function() {
    var $select = $(this);
    var newQuantity = $select.val();
    var productId = $select.data('product-id');  // Get the product ID from the data attribute

    // Send the AJAX request
    $.ajax({
        url: '{% url "myapp:update" %}',  // Replace with your actual endpoint
        type: 'POST',
        data: {
            product_id: productId,
            qte: newQuantity,
            csrfmiddlewaretoken: '{{ csrf_token }}',  // Make sure the CSRF token is populated
            action: 'update'
        },
        success: function(response) {
            // Update cart icon or other elements dynamically
            console.log("Quantity updated successfully:", response);
            document.querySelector('.cart-count').textContent = response.qte;
        var parentDiv = $select.parent();
        var nextDiv = parentDiv.next('.total-price');
        var spanElement = nextDiv.find('.span');
        console.log(response.price);  
        spanElement.text('$' + response.price);
        console.log($select);
        $('.order-summary .total-price').text('Total: $' + response.total);
                $('.order-summary .discount').text('Discount: -$' + response.discount);
                $('.order-summary .final-total').text('Estimated Total: $' + response.final_total);
        },
        error: function() {
            console.error('Error updating quantity');
            alert('Failed to update quantity. Please try again.');
        }
    });
});

$(document).on('click', '.remove-item', function(event) {
    event.preventDefault(); 

    var $cartItem = $(this).closest('.cart-item'); 
    var productId = $cartItem.data('product-id'); 

    
    if (confirm('Are you sure you want to remove this item from the cart?')) {
        
        $.ajax({
            url: '{% url "myapp:delete_pro" %}', 
            type: 'POST',
            data: {
                product_id: productId,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action:'delete' 
            },
            success: function(response) {
                console.log('Item removed successfully:', response);
                document.querySelector('.cart-count').textContent = response.qte;
                $cartItem.remove(); 
                $('.order-summary .total-price').text('Total: $' + response.total);
                $('.order-summary .discount').text('Discount: -$' + response.discount);
                $('.order-summary .final-total').text('Estimated Total: $' + response.final_total);
                console.log(response.final_total)
            },
            error: function(xhr, status, error) {
                console.error('Error removing item:', error);
                alert('Failed to remove item from cart. Please try again.');
            }
        });
    }
});


    



    </script>
    {% include "footer.html" %}
</body>
</html>